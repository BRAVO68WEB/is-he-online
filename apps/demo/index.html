<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Activity Monitor - Live Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2f3136;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ed4245;
        }
        .status-indicator.connected {
            background: #57f287;
        }
        .user-card {
            background: #36393f;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .activity-list {
            background: #36393f;
            border-radius: 8px;
            padding: 16px;
        }
        .activity-item {
            background: #40444b;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .activity-item:last-child {
            margin-bottom: 0;
        }
        .activity-name {
            font-weight: 600;
            color: #00d166;
        }
        .activity-details {
            font-size: 0.9em;
            color: #b9bbbe;
            margin-top: 4px;
        }
        .timestamp {
            font-size: 0.8em;
            color: #72767d;
            text-align: right;
        }
        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 24px;
        }
        h2 {
            color: #fff;
            margin-top: 0;
        }
        .logs {
            background: #2f3136;
            border: 1px solid #40444b;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <h1>üéÆ Discord Activity Monitor</h1>
    
    <div class="container">
        <div class="status">
            <div class="status-indicator" id="connectionStatus"></div>
            <span id="connectionText">Connecting to server...</span>
        </div>

        <div class="user-card" id="userCard">
            <h2>üë§ User Information</h2>
            <div id="userInfo">
                <p>Waiting for user data...</p>
            </div>
        </div>

        <div class="activity-list" id="activityList">
            <h2>üéØ Discord Activities</h2>
            <div id="activities">
                <p>No Discord activities detected</p>
            </div>
        </div>

        <div class="activity-list" id="vscodeActivityList">
            <h2>üíª VSCode Activity</h2>
            <div id="vscodeActivity">
                <p>No VSCode activity detected</p>
            </div>
        </div>

        <div class="timestamp" id="lastUpdate">
            Last update: Never
        </div>

        <div class="logs" id="logs">
            <strong>Event Log:</strong><br>
        </div>
    </div>

    <script>
        class ActivityMonitor {
            constructor() {
                this.eventSource = null;
                this.connected = false;
                this.logs = [];
                this.setupEventSource();
                this.setupUI();
            }

            setupUI() {
                this.statusIndicator = document.getElementById('connectionStatus');
                this.statusText = document.getElementById('connectionText');
                this.userInfo = document.getElementById('userInfo');
                this.activities = document.getElementById('activities');
                this.vscodeActivity = document.getElementById('vscodeActivity');
                this.lastUpdate = document.getElementById('lastUpdate');
                this.logs = document.getElementById('logs');
            }

            setupEventSource() {
                this.log('Connecting to SSE endpoint...');
                
                this.eventSource = new EventSource('http://localhost:3000/events');

                this.eventSource.onopen = () => {
                    this.connected = true;
                    this.updateConnectionStatus();
                    this.log('‚úÖ Connected to server');
                };

                this.eventSource.onerror = (error) => {
                    this.connected = false;
                    this.updateConnectionStatus();
                    this.log('‚ùå Connection error: ' + error.type);
                };

                this.eventSource.addEventListener('activity-update', (event) => {
                    const activity = JSON.parse(event.data);
                    this.updateActivity(activity);
                    this.log('üîÑ Discord activity update received');
                });

                this.eventSource.addEventListener('vscode-update', (event) => {
                    const activity = JSON.parse(event.data);
                    this.updateVSCodeActivity(activity);
                    this.log('üíª VSCode activity update received');
                });

                this.eventSource.addEventListener('heartbeat', (event) => {
                    const data = JSON.parse(event.data);
                    this.log('üíì Heartbeat: ' + new Date(data.timestamp).toLocaleTimeString());
                });

                this.eventSource.addEventListener('vscode-offline', (event) => {
                    const data = JSON.parse(event.data);
                    this.vscodeActivity.innerHTML = '<p>VSCode is offline - Extension closed or heartbeat timeout</p>';
                    this.log('üíª‚ùå VSCode went offline: ' + data.reason);
                });

                this.eventSource.addEventListener('discord-offline', (event) => {
                    const data = JSON.parse(event.data);
                    this.activities.innerHTML = '<p>Discord is offline - Bot disconnected or heartbeat timeout</p>';
                    this.log('üë§‚ùå Discord went offline: ' + data.reason);
                });
            }

            updateConnectionStatus() {
                if (this.connected) {
                    this.statusIndicator.classList.add('connected');
                    this.statusText.textContent = 'Connected to Discord Activity Monitor';
                } else {
                    this.statusIndicator.classList.remove('connected');
                    this.statusText.textContent = 'Disconnected from server';
                }
            }

            updateActivity(activity) {
                // Update user info
                this.userInfo.innerHTML = `
                    <p><strong>Username:</strong> ${activity.username}#${activity.discriminator}</p>
                    <p><strong>User ID:</strong> ${activity.userId}</p>
                    <p><strong>Status:</strong> <span style="color: ${this.getStatusColor(activity.status)}">${activity.status}</span></p>
                `;

                // Update activities
                if (activity.activities.length === 0) {
                    this.activities.innerHTML = '<p>No Discord activities detected</p>';
                } else {
                    this.activities.innerHTML = activity.activities.map(act => `
                        <div class="activity-item">
                            <div class="activity-name">${this.getActivityTypeIcon(act.type)} ${act.name}</div>
                            ${act.details ? `<div class="activity-details"><strong>Details:</strong> ${act.details}</div>` : ''}
                            ${act.state ? `<div class="activity-details"><strong>State:</strong> ${act.state}</div>` : ''}
                            ${act.timestamps?.start ? `<div class="activity-details"><strong>Started:</strong> ${new Date(act.timestamps.start).toLocaleString()}</div>` : ''}
                        </div>
                    `).join('');
                }

                // Update timestamp
                this.lastUpdate.textContent = `Last Discord update: ${new Date(activity.timestamp).toLocaleString()}`;
            }

            getActivityTypeIcon(type) {
                const icons = {
                    0: 'üéÆ', // Playing
                    1: 'üì∫', // Streaming
                    2: 'üéµ', // Listening
                    3: 'üëÄ', // Watching
                    4: 'üí≠', // Custom
                    5: 'üèÜ'  // Competing
                };
                return icons[type] || '‚ùì';
            }

            getStatusColor(status) {
                const colors = {
                    'online': '#57f287',
                    'idle': '#faa61a',
                    'dnd': '#ed4245',
                    'offline': '#80848e'
                };
                return colors[status] || '#80848e';
            }

            updateVSCodeActivity(activity) {
                const sessionInfo = activity.session ? `
                    <div class="activity-details"><strong>Session:</strong> ${activity.session.sessionId}</div>
                    <div class="activity-details"><strong>Session Duration:</strong> ${this.formatDuration(activity.session.duration)}</div>
                    <div class="activity-details"><strong>Session Status:</strong> ${activity.session.status}</div>
                ` : '';

                const editorInfo = activity.activity ? `
                    <div class="activity-details"><strong>File:</strong> ${activity.activity.editor.fileName}</div>
                    <div class="activity-details"><strong>Path:</strong> ${activity.activity.editor.filePath}</div>
                    <div class="activity-details"><strong>Language:</strong> ${activity.activity.editor.language}</div>
                    <div class="activity-details"><strong>Position:</strong> Line ${activity.activity.editor.lineNumber}, Column ${activity.activity.editor.columnNumber}</div>
                    ${activity.activity.workspace.gitRepo ? `
                        <div class="activity-details"><strong>Git Repo:</strong> ${activity.activity.workspace.gitRepo.name}</div>
                        <div class="activity-details"><strong>Branch:</strong> ${activity.activity.workspace.gitRepo.branch}</div>
                    ` : ''}
                ` : '<div class="activity-details"><em>No current activity</em></div>';

                this.vscodeActivity.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-name">üìÅ ${activity.activity?.workspace.name || 'VSCode Session'}</div>
                        ${editorInfo}
                        ${sessionInfo}
                        <div class="activity-details"><strong>Last Seen:</strong> ${new Date(activity.last_seen).toLocaleString()}</div>
                    </div>
                `;
            }

            formatDuration(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${seconds % 60}s`;
                } else {
                    return `${seconds}s`;
                }
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                this.logs.innerHTML += `<br>[${timestamp}] ${message}`;
                this.logs.scrollTop = this.logs.scrollHeight;
            }
        }

        // Initialize the monitor when page loads
        window.addEventListener('DOMContentLoaded', () => {
            new ActivityMonitor();
        });
    </script>
</body>
</html>